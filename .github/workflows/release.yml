name: Create new Release
on:
    workflow_dispatch
jobs:
    build-docker-images:
        runs-on: ubuntu-latest
        outputs:
            version: ${{ steps.get_tag.outputs.PACKAGE_VERSION }}
        steps:
            - name: Checkout Repository
              uses: actions/checkout@v4
            - name: Login to Docker Hub
              uses: docker/login-action@v3
              with:
                  username: ${{ secrets.DOCKER_USERNAME }}
                  password: ${{ secrets.DOCKER_PASSWORD }}
            - name: Setup QEMU
              uses: docker/setup-qemu-action@v3
            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3
            - name: Get Image tag
              id: get_tag
              run: |
                echo "PACKAGE_VERSION="$(jq -r '.version' package.json)" >> $GITHUB_OUTPUT
            - name: Build and push
              uses: docker/build-push-action@v6
              with:
                  context: .
                  push: true
                  tags: rastogiji54/mockai:${{ steps.get_tag.outputs.PACKAGE_VERSION }}
                  platforms: linux/amd64,linux/arm64
    generate_release:
        runs-on: ubuntu-latest
        needs: build-docker-images
        steps:
            - name: Checkout Repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
            - name: Generate Changelog
              id: changelog
              uses: janheinrichmerker/action-github-changelog-generator@v2.3
              with:
                token: ${{ secrets.GITHUB_TOKEN }}
            - name: Create Tag
              id: create_tag
              uses: mathieudutour/github-tag-action@v6.2
              with:
                  github_token: ${{ secrets.GITHUB_TOKEN }}
                  custom_tag: ${{ needs.build-docker-images.outputs.version }}
                  tag_prefix: v
            - name: Create Release
              id: create_release
              uses: actions/create-release@v1
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  tag_name: 'v${{ needs.build-docker-images.outputs.version }}'
                  release_name: 'v${{ needs.build-docker-images.outputs.version }}'
                  body: |
                    Changes in this Release:
                    ${{ steps.changelog.outputs.changelog }}
                  draft: false
                  prerelease: false
    
